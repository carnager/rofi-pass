#!/usr/bin/env bash

source $HOME/.config/rofi-pass/config

if [[ -n "$3" && "$2" == "--root" ]]; then
    root="${2}"
elif [[ -n $root ]]; then
    root=$root
elif [[ -n $PASSWORD_STORE_DIR ]]; then
    root=$PASSWORD_STORE_DIR
else
    root="$HOME/.password-store"
fi

if [[ $1 == "--help" ]] || [[ $1 == "-h" ]]; then
    cat << EOH
add pass files for rofi-pass
(C) 2015 Rasmus Steinke <rasi at xssn dot at>

--name \"foobar\"     Mandatory first argument - filename of password file
--root \"foobar\"     Optional second argument - Absolute path to password store

+FIELD \"barbaz\"     Every field name has to start with \"+\"
                    Values should be quoted

Example:
 % addpass --name \"my password file\" --root \"$HOME/passwords\" +user \"Richard\" +foo \"bar\" +autotype \"foo :tab user :tab pass\"
EOH
    exit
else
    echo "$1"
    if [[ $1 != "--name" ]]; then
        echo "Missing --name option. Try --help"
        exit
    elif [[ $1 == "--name" ]]; then
        name="$2"
    fi
fi

echo "Using database \"$root\""

OIFS=$IFS;
IFS="+";

fields="$@";
fieldsArray=($fields);
read -p "Enter password for entry \"${name}\" > " -s pass

cd "${root}"
group=$(echo -e "No Group\n---\n$(find -type d -not -iwholename '*.git*' -printf '%d\t%P\n' | sort -r -nk1 | cut -f2-)" | rofi -dmenu -p "Choose Group > ")

echo -e "\n\nStoring file ${name} in group ${group}"

printEntry () {
    echo -e "$pass\n---"
    for ((i=1; i<${#fieldsArray[@]}; ++i)); do
        field=$(echo "${fieldsArray[$i]}" | awk -F' ' '{print $1}')
        option=$(echo "${fieldsArray[$i]}" | cut -d ' ' -f 2- | sed -e 's/[[:blank:]]\+$//')
        echo "$field: $option" | grep -Ev 'name:|--root|root:|^:' #${fieldsArray[$i]}";
    done
}

if [[ "$group" == "No Group" ]]; then
    printEntry | PASSWORD_STORE_DIR="${root}" pass insert -m "${name}"
elif [[ "$group" == "" ]]; then
    exit
else
    printEntry | PASSWORD_STORE_DIR="${root}" pass insert -m "${group}/${name}"
fi
